# æ•°æ® (Data)

é€šå¸¸ï¼Œäººä»¬ä¼šåœ¨æŸä¸ªæ•°æ®é›†ä¸Šè®­ç»ƒæ¨¡å‹ã€‚Burn æä¾›äº†ä¸€ä¸ªéå¸¸æœ‰ç”¨çš„æ•°æ®é›†æºå’Œè½¬æ¢åº“ï¼Œä¾‹å¦‚ Hugging Face æ•°æ®é›†å·¥å…·ï¼Œå…è®¸ä¸‹è½½æ•°æ®å¹¶å°†å…¶å­˜å‚¨åˆ° SQLite æ•°æ®åº“ä¸­ï¼Œä»¥å®ç°æå…¶é«˜æ•ˆçš„æ•°æ®æµå’Œå­˜å‚¨ã€‚ä¸è¿‡ï¼Œåœ¨æœ¬æŒ‡å—ä¸­ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨æ¥è‡ª `burn::data::dataset::vision` çš„ MNIST æ•°æ®é›†ï¼Œè¯¥æ•°æ®é›†ä¸éœ€è¦å¤–éƒ¨ä¾èµ–ã€‚

ä¸ºäº†é«˜æ•ˆåœ°è¿­ä»£æ•°æ®é›†ï¼Œæˆ‘ä»¬å°†å®šä¹‰ä¸€ä¸ªå®ç° `Batcher` trait çš„ç»“æ„ä½“ã€‚æ‰¹å¤„ç†å™¨çš„ç›®æ ‡æ˜¯å°†å•ä¸ªæ•°æ®é›†é¡¹ç›®æ˜ å°„ä¸ºå¯ç”¨äºè¾“å…¥åˆ°æˆ‘ä»¬ä¹‹å‰å®šä¹‰æ¨¡å‹çš„æ‰¹å¤„ç†å¼ é‡ã€‚

è®©æˆ‘ä»¬å¼€å§‹åœ¨æ–°æ–‡ä»¶ `src/data.rs` ä¸­å®šä¹‰æˆ‘ä»¬çš„æ•°æ®é›†åŠŸèƒ½ã€‚ä¸ºç®€æ´èµ·è§ï¼Œæˆ‘ä»¬å°†çœç•¥ä¸€äº›å¯¼å…¥ï¼Œä½†éµå¾ªæœ¬æŒ‡å—çš„å®Œæ•´ä»£ç å¯ä»¥åœ¨ `examples/guide/` <a href="https://github.com/tracel-ai/burn/tree/main/examples/guide">ç›®å½•</a>ä¸­æ‰¾åˆ°ã€‚

```rust
use burn::{
    data::{dataloader::batcher::Batcher, dataset::vision::MnistItem},
    prelude::*,
};


#[derive(Clone, Default)]
pub struct MnistBatcher {}
```

è¿™ä¸ªæ‰¹å¤„ç†å™¨éå¸¸ç®€å•ï¼Œå› ä¸ºå®ƒåªå®šä¹‰äº†ä¸€ä¸ªå°†å®ç° `Batcher` trait çš„ç»“æ„ä½“ã€‚è¯¥ trait å¯¹äº `Backend` trait æ˜¯æ³›å‹çš„ï¼Œåè€…åŒ…å«äº†è®¾å¤‡çš„å…³è”ç±»å‹ï¼Œå› ä¸ºå¹¶éæ‰€æœ‰åç«¯éƒ½æš´éœ²ç›¸åŒçš„è®¾å¤‡ã€‚ä¾‹å¦‚ï¼ŒåŸºäº Libtorch çš„åç«¯æš´éœ² `Cuda(gpu_index)`ã€`Cpu`ã€`Vulkan` å’Œ `Metal` è®¾å¤‡ï¼Œè€Œ ndarray åç«¯åªæš´éœ² `Cpu` è®¾å¤‡ã€‚

æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬éœ€è¦å®é™…å®ç°æ‰¹å¤„ç†é€»è¾‘ã€‚

```rust
use burn::{
    data::{dataloader::batcher::Batcher, dataset::vision::MnistItem},
    prelude::*,
};

#[derive(Clone, Default)]
pub struct MnistBatcher {}

#[derive(Clone, Debug)]
pub struct MnistBatch<B: Backend> {
    pub images: Tensor<B, 3>,
    pub targets: Tensor<B, 1, Int>,
}

impl<B: Backend> Batcher<B, MnistItem, MnistBatch<B>> for MnistBatcher {
    fn batch(&self, items: Vec<MnistItem>, device: &B::Device) -> MnistBatch<B> {
        let images = items
            .iter()
            .map(|item| TensorData::from(item.image).convert::<B::FloatElem>())
            .map(|data| Tensor::<B, 2>::from_data(data, device))
            .map(|tensor| tensor.reshape([1, 28, 28]))
            // å½’ä¸€åŒ–ï¼šåœ¨ [0,1] ä¹‹é—´ç¼©æ”¾å¹¶ä½¿ mean=0 å’Œ std=1
            // å€¼ mean=0.1307, std=0.3081 æ¥è‡ª PyTorch MNIST ç¤ºä¾‹
            // https://github.com/pytorch/examples/blob/54f4572509891883a947411fd7239237dd2a39c3/mnist/main.py#L122
            .map(|tensor| ((tensor / 255) - 0.1307) / 0.3081)
            .collect();

        let targets = items
            .iter()
            .map(|item| {
                Tensor::<B, 1, Int>::from_data([(item.label as i64).elem::<B::IntElem>()], device)
            })
            .collect();

        let images = Tensor::cat(images, 0);
        let targets = Tensor::cat(targets, 0);

        MnistBatch { images, targets }
    }
}
```

<details>
<summary><strong>ğŸ¦€ è¿­ä»£å™¨å’Œé—­åŒ…</strong></summary>
<p>è¿­ä»£å™¨æ¨¡å¼å…è®¸æ‚¨ä¾æ¬¡å¯¹ä¸€ç³»åˆ—é¡¹ç›®æ‰§è¡ŒæŸäº›ä»»åŠ¡ã€‚</p>

<p>åœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œé€šè¿‡è°ƒç”¨ `iter` æ–¹æ³•åœ¨ `items` å‘é‡ä¸­çš„ `MnistItem` ä¸Šåˆ›å»ºè¿­ä»£å™¨ã€‚</p>

<p><em>è¿­ä»£å™¨é€‚é…å™¨</em>æ˜¯å®šä¹‰åœ¨ `Iterator` trait ä¸Šçš„æ–¹æ³•ï¼Œé€šè¿‡æ›´æ”¹åŸå§‹è¿­ä»£å™¨çš„æŸäº›æ–¹é¢æ¥äº§ç”Ÿä¸åŒçš„è¿­ä»£å™¨ã€‚åœ¨è¿™é‡Œï¼Œ`map` æ–¹æ³•åœ¨é“¾ä¸­è¢«è°ƒç”¨ï¼Œä»¥åœ¨ä½¿ç”¨ `collect` è·å–æœ€ç»ˆè¿­ä»£å™¨ä¹‹å‰è½¬æ¢åŸå§‹æ•°æ®ï¼Œä»è€Œè·å¾— `images` å’Œ `targets` å‘é‡ã€‚ç„¶åä¸¤ä¸ªå‘é‡è¢«è¿æ¥æˆå½“å‰æ‰¹æ¬¡çš„å•ä¸ªå¼ é‡ã€‚</p>

<p>æ‚¨å¯èƒ½æ³¨æ„åˆ°æ¯æ¬¡å¯¹ `map` çš„è°ƒç”¨éƒ½ä¸åŒï¼Œå› ä¸ºå®ƒå®šä¹‰äº†åœ¨æ¯ä¸ªè¿­ä»£æ­¥éª¤ä¸­å¯¹è¿­ä»£å™¨é¡¹ç›®æ‰§è¡Œçš„å‡½æ•°ã€‚è¿™äº›åŒ¿åå‡½æ•°åœ¨ Rust ä¸­è¢«ç§°ä¸º<a href="https://doc.rust-lang.org/book/ch13-01-closures.html"><em>é—­åŒ…</em></a>ã€‚ç”±äºå®ƒä»¬ä½¿ç”¨ç«–çº¿ `||` çš„è¯­æ³•ï¼Œå®ƒä»¬å¾ˆå®¹æ˜“è¯†åˆ«ã€‚ç«–çº¿æ•è·è¾“å…¥å˜é‡ï¼ˆå¦‚æœé€‚ç”¨ï¼‰ï¼Œè€Œè¡¨è¾¾å¼çš„å…¶ä½™éƒ¨åˆ†å®šä¹‰äº†è¦æ‰§è¡Œçš„å‡½æ•°ã€‚</p>

<p>å¦‚æœæˆ‘ä»¬å›åˆ°ç¤ºä¾‹ä¸­ï¼Œå¯ä»¥åˆ†è§£å¹¶æ³¨é‡Šç”¨äºå¤„ç†å›¾åƒçš„è¡¨è¾¾å¼ã€‚</p>

```rust
let images = items                                                       // take items Vec<MnistItem>;
    .iter()                                                              // åœ¨å…¶ä¸Šåˆ›å»ºè¿­ä»£å™¨
    .map(|item| TensorData::from(item.image).convert::<B::FloatElem>())  // å¯¹äºæ¯ä¸ªé¡¹ç›®ï¼Œå°†å›¾åƒè½¬æ¢ä¸ºæµ®ç‚¹æ•°æ®ç»“æ„
    .map(|data| Tensor::<B, 2>::from_data(data, device))                 // å¯¹äºæ¯ä¸ªæ•°æ®ç»“æ„ï¼Œåœ¨è®¾å¤‡ä¸Šåˆ›å»ºå¼ é‡
    .map(|tensor| tensor.reshape([1, 28, 28]))                           // å¯¹äºæ¯ä¸ªå¼ é‡ï¼Œé‡å¡‘ä¸ºå›¾åƒç»´åº¦ [C, H, W]
    .map(|tensor| ((tensor / 255) - 0.1307) / 0.3081)                    // å¯¹äºæ¯ä¸ªå›¾åƒå¼ é‡ï¼Œåº”ç”¨å½’ä¸€åŒ–
    .collect();                                                          // æ¶ˆè´¹ç»“æœè¿­ä»£å™¨å¹¶å°†å€¼æ”¶é›†åˆ°æ–°å‘é‡ä¸­
```

<p>æœ‰å…³è¿­ä»£å™¨å’Œé—­åŒ…çš„æ›´å¤šä¿¡æ¯ï¼Œè¯·åŠ¡å¿…æŸ¥çœ‹ Rust Book ä¸­çš„<a href="https://doc.rust-lang.org/book/ch13-00-functional-features.html">ç›¸åº”ç« èŠ‚</a>ã€‚</p>
</details><br>

åœ¨å‰é¢çš„ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬ä½¿ç”¨ `MnistItem` åˆ—è¡¨ä½œä¸ºè¾“å…¥å’Œå•ä¸ª `MnistBatch` ä½œä¸ºè¾“å‡ºæ¥å®ç° `Batcher` traitã€‚æ‰¹æ¬¡åŒ…å« 3D å¼ é‡å½¢å¼çš„å›¾åƒï¼Œä»¥åŠåŒ…å«æ­£ç¡®æ•°å­—ç±»åˆ«ç´¢å¼•çš„ç›®æ ‡å¼ é‡ã€‚ç¬¬ä¸€æ­¥æ˜¯å°†å›¾åƒæ•°ç»„è§£æä¸º `TensorData` ç»“æ„ä½“ã€‚Burn æä¾› `TensorData` ç»“æ„ä½“æ¥å°è£…å¼ é‡å­˜å‚¨ä¿¡æ¯ï¼Œè€Œä¸ç‰¹å®šäºåç«¯ã€‚å½“ä»æ•°æ®åˆ›å»ºå¼ é‡æ—¶ï¼Œæˆ‘ä»¬é€šå¸¸éœ€è¦å°†æ•°æ®ç²¾åº¦è½¬æ¢ä¸ºå½“å‰ä½¿ç”¨çš„åç«¯ã€‚è¿™å¯ä»¥é€šè¿‡ `.convert()` æ–¹æ³•å®Œæˆï¼ˆåœ¨æ­¤ç¤ºä¾‹ä¸­ï¼Œæ•°æ®è¢«è½¬æ¢ä¸ºåç«¯çš„æµ®ç‚¹å…ƒç´ ç±»å‹ `B::FloatElem`ï¼‰ã€‚åœ¨å¯¼å…¥ `burn::tensor::ElementConversion` trait æ—¶ï¼Œæ‚¨å¯ä»¥åœ¨ç‰¹å®šæ•°å­—ä¸Šè°ƒç”¨ `.elem()` å°†å…¶è½¬æ¢ä¸ºå½“å‰ä½¿ç”¨çš„åç«¯å…ƒç´ ç±»å‹ã€‚

---

*æœ¬æ–‡æ¡£ç¿»è¯‘è‡ª Burn å®˜æ–¹æ–‡æ¡£ï¼šhttps://burn.dev/books/burn/basic-workflow/data.html*
